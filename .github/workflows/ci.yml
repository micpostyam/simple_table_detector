# Workflow d'IntÃ©gration Continue (CI)
# Ce pipeline automatise les tests, la compilation et la validation du code
name: CI

# ğŸ”„ DÃ©clencheurs du workflow
# Le pipeline s'exÃ©cute automatiquement dans ces situations :
on:
  push:
    branches: main  # âœ… Ã€ chaque push sur la branche main
  pull_request:
    branches: main  # ğŸ”€ Ã€ chaque Pull Request vers main

# ğŸ› ï¸ Jobs du pipeline CI
jobs:
  # Job principal : construction et tests
  build-and-test:
    # ğŸ–¥ï¸ Environnement d'exÃ©cution : Ubuntu derniÃ¨re version
    runs-on: ubuntu-latest
    
    # ğŸ³ Services nÃ©cessaires (conteneurs Docker)
    services:
      docker:
        # Service Docker-in-Docker pour construire des images dans le pipeline
        image: docker:24.0.7-dind
    
    # ğŸ“‹ Ã‰tapes d'exÃ©cution du job
    steps:
      # ğŸ“¥ Ã‰TAPE 1: RÃ©cupÃ©ration du code source
      - name: Checkout code
        uses: actions/checkout@v4  # Action officielle GitHub pour cloner le repo
        # Cette Ã©tape tÃ©lÃ©charge tout le code du repository dans l'environnement CI

      # ğŸ Ã‰TAPE 2: Configuration de l'environnement Python
      - name: Set up Python
        uses: actions/setup-python@v5  # Action officielle pour installer Python
        with:
          python-version: '3.11'  # Version Python spÃ©cifique pour la cohÃ©rence
        # Assure que tous les builds utilisent la mÃªme version Python

      # ğŸ“¦ Ã‰TAPE 3: Installation des dÃ©pendances Python
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip  # ğŸ”„ Mise Ã  jour de pip
          pip install -r requirements.txt     # ğŸ“‹ Installation des dÃ©pendances du projet
        # Cette Ã©tape prÃ©pare l'environnement avec toutes les librairies nÃ©cessaires

      # ğŸ” Ã‰TAPE 4: Analyse statique du code (Linting)
      - name: Lint with flake8
        run: |
          pip install flake8  # ğŸ› ï¸ Installation de l'outil de linting
          # ğŸ” Analyse du code pour dÃ©tecter les erreurs critiques :
          # E9: erreurs de syntaxe, F63: erreurs d'import, F7: erreurs logiques, F82: variables non dÃ©finies
          flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Le linting vÃ©rifie la qualitÃ© du code sans l'exÃ©cuter

      # ğŸ§ª Ã‰TAPE 5: ExÃ©cution des tests unitaires
      - name: Run tests
        run: |
          pip install pytest  # ğŸ§ª Installation du framework de test
          # ExÃ©cution des tests avec options :
          # --maxfail=1: arrÃªt au premier Ã©chec
          # --disable-warnings: masque les avertissements
          # --tb=short: format concis pour les erreurs
          pytest --maxfail=1 --disable-warnings --tb=short
        # Les tests valident que le code fonctionne comme attendu

      # ğŸ³ Ã‰TAPE 6: Construction de l'image Docker de l'API
      - name: Build API Docker image
        run: |
          # Construction de l'image Docker pour l'API backend
          docker build -f Dockerfile.api -t table-detector-api .
        # VÃ©rifie que l'API peut Ãªtre conteneurisÃ©e correctement

      # ğŸ³ Ã‰TAPE 7: Construction de l'image Docker du Frontend
      - name: Build Frontend Docker image
        run: |
          # Construction de l'image Docker pour le frontend
          docker build -f Dockerfile.frontend -t table-detector-frontend .
        # VÃ©rifie que le frontend peut Ãªtre conteneurisÃ© correctement

      # ğŸš€ Ã‰TAPE 8: Test d'intÃ©gration avec Docker Compose (Smoke Test)
      - name: Docker Compose up (smoke test)
        run: |
          # ğŸš€ DÃ©marrage de l'application complÃ¨te
          docker compose up -d --build
          # â±ï¸ Attente pour que les services dÃ©marrent
          sleep 10
          # ğŸ“Š VÃ©rification du statut des conteneurs
          docker compose ps
          # ğŸ“‹ Affichage des logs pour diagnostic
          docker compose logs api
          docker compose logs frontend
        # Ce test vÃ©rifie que l'application complÃ¨te peut dÃ©marrer

      # ğŸ¥ Ã‰TAPE 9: VÃ©rification de la santÃ© de l'API
      - name: Check API health
        run: |
          # ğŸ” Test de l'endpoint de documentation de l'API
          # --fail fait Ã©chouer la commande si l'HTTP status n'est pas 2xx
          curl --fail http://localhost:8000/docs
        # VÃ©rifie que l'API rÃ©pond correctement aux requÃªtes HTTP

      # ğŸ§¹ Ã‰TAPE 10: Nettoyage (toujours exÃ©cutÃ©e)
      - name: Tear down
        if: always()  # ğŸ”„ Cette Ã©tape s'exÃ©cute mÃªme si les prÃ©cÃ©dentes Ã©chouent
        run: |
          # ğŸ›‘ ArrÃªt et suppression de tous les conteneurs
          docker compose down
        # Nettoie l'environnement pour Ã©viter les conflits futurs

# ğŸ“Š RÃ©sumÃ© du pipeline CI :
# 1. ğŸ“¥ RÃ©cupÃ©ration du code
# 2. ğŸ Configuration Python
# 3. ğŸ“¦ Installation des dÃ©pendances
# 4. ğŸ” VÃ©rification qualitÃ© du code (linting)
# 5. ğŸ§ª Tests unitaires
# 6. ğŸ³ Construction images Docker
# 7. ğŸš€ Test d'intÃ©gration complet
# 8. ğŸ¥ VÃ©rification santÃ© API
# 9. ğŸ§¹ Nettoyage

# âœ… Si toutes les Ã©tapes passent = code prÃªt pour la production
# âŒ Si une Ã©tape Ã©choue = problÃ¨me Ã  corriger avant merge